<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Waypoints in directions</title>
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
</head>
<body>
<div id="map"></div>
<div id="right-panel">
    <div>
        <b>Przystanki:</b> <br>
        <div id="waypointsWrapper"><p><i>Wgraj plik z listą przystanków</i></p></div>

        <input type="submit" id="submit" value="Oblicz trasę">
        <br>
        <br>
        <div id="page-wrapper">
            <div>
                Wybierz plik z adresami:
                <input type="file" id="fileInput">
            </div>
		<pre id="fileDisplayArea"></pre>
        </div>
        <br>
        <br>
        <input type="button" id="busstops" value="Generuj przystanki autobusowe">
    </div>
</div>
<script>
    //todo: move js to separate files
    var waypts = [];

    window.onload = function() {
        var fileInput = document.getElementById('fileInput');
        var fileDisplayArea = document.getElementById('fileDisplayArea');

        fileInput.addEventListener('change', function(e) {
            var file = fileInput.files[0];
            var textType = /text.*/;

            if (file.type.match(textType)) {
                var reader = new FileReader();
                 reader.onload = function(progressEventDupaStasia){
                     var lines = this.result.split('\n');
                     var addressList = '<ul id="waypoints">';
                     for(var line = 0; line < lines.length; line++){
                         console.log(lines[line]);
                         addressList +=  "<li>";
                         addressList += lines[line];
                         addressList += "</li>";
                         createLatLngFromAddress(lines[line]);
                     }

                     addressList += "</ul>";
                     document.getElementById('waypointsWrapper').innerHTML = addressList;
                 }

                reader.readAsText(file);
                fileDisplayArea.innerText = "";
            } else {
                fileDisplayArea.innerText = "File not supported!"
            }
        });
    }

    function createLatLngFromAddress(address){
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: address }, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                console.log("Creating LatLang object from address... " + results[0].geometry.location.lat() + " " + results[0].geometry.location.lng());
                waypts.push(
                        {
                            lat: results[0].geometry.location.lat(),
                            lng:  results[0].geometry.location.lng()
                        }


            );
            }
        });
    }

    var globalMap;

    function initMap() {
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: new google.maps.LatLng(52.133999, 21.074677)
            //center: {lat: 52.133999, lng: 21.074677}
        });
        directionsDisplay.setMap(map);

        document.getElementById('submit').addEventListener('click', function() {
            calculateAndDisplayRoute(directionsService, directionsDisplay);
        });

        globalMap = map;
        document.getElementById('busstops').addEventListener('click', function() {
            generateBusStops();
        });
    }




    var busStops = [];
    function generateBusStops(){
        console.log("Start iterating through waypoints... " + waypts);
       //waypts.forEach(searchNearby); //todo: maybe this will work

        for(var i=0; i<waypts.length; i++){
            searchNearby(waypts[i], i);
        }

    }

    function searchNearby(item, index){
        var service = new google.maps.places.PlacesService(globalMap);
        console.log("Generating bus stop from " +  new google.maps.LatLng(item.lat, item.lng) + " index: " + index);
        service.nearbySearch({
            location: new google.maps.LatLng(item.lat, item.lng),
            radius: 500,
            type: ['bus_stop']
        },nearbySearchCallback)
    }

    function nearbySearchCallback(results, status){
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            console.log("Generation bus stop location" + results[1].geometry.location);
            busStops.push({
                location: results[1].geometry.location,   //todo: why results[1]? Also: it generates close, but weird locations, make it better
                stopover: true
            });
        }
    }




    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        var originAndDestination = "Jana Rosoła 10, Warszawa";
        console.log(busStops);
        directionsService.route({
            origin: originAndDestination,
            destination: originAndDestination,
            waypoints: busStops,
            optimizeWaypoints: true,
            travelMode: 'DRIVING'
            }, function(response, status) {
                if (status === 'OK') {
                    directionsDisplay.setDirections(response);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
    }



</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&callback=initMap">
</script>
</body>
</html>